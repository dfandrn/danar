<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Demo OTP + Pulsa/PLN</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    .form-box { max-width: 400px; margin: 100px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);}
    input, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; }
    button { background: #007bff; color: white; cursor: pointer; border: none; }
    button:hover { background: #0056b3; }
    .hidden { display: none; }
    .price-card.active { border:2px solid blue; }
    .txn-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; }
    .badge { background: green; color:white; padding:2px 6px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>

<!-- ========= LOGIN PAGE ========= -->
<div id="loginPage" class="page active">
  <div class="form-box">
    <h2>Login dengan Nomor WA</h2>
    <input type="text" id="phone" placeholder="Masukkan nomor WA (ex: 6281234567890)">
    <button id="sendOtpBtn">Kirim OTP</button>
    <input type="text" id="otp" placeholder="Masukkan OTP" class="hidden">
    <button id="verifyOtpBtn" class="hidden">Verifikasi OTP</button>
  </div>
</div>

<!-- ========= MAIN PAGE ========= -->
<div id="mainPage" class="page">
  <h2>Selamat datang!</h2>
  <p>Saldo: <span id="balance">0</span></p>
  <button id="topUpBtn">Top Up</button>
  <button id="withdrawBtn">Tarik</button>
  
  <h3>Pembelian PLN</h3>
  <input id="plnId" placeholder="Masukkan ID Pelanggan">
  <div id="plnGrid">
    <div class="price-card" onclick="selectPln(0)">Token 20k</div>
    <div class="price-card" onclick="selectPln(1)">Token 50k</div>
    <div class="price-card" onclick="selectPln(2)">Token 100k</div>
  </div>
  <div id="plnSummary" class="hidden">
    Harga: <span id="plnHarga"></span><br>
    Admin: <span id="plnAdmin"></span><br>
    Diskon: <span id="plnDiskon"></span><br>
    Total: <span id="plnTotal"></span><br>
    <button id="plnBayar">Bayar</button>
    <button id="plnReset">Reset</button>
  </div>

  <h3>Riwayat Transaksi</h3>
  <div id="emptyTxn">Belum ada transaksi</div>
  <div id="txnList"></div>
</div>

<script>
/* ========== LOGIN HANDLER ========== */
const loginPage = document.getElementById('loginPage');
const mainPage = document.getElementById('mainPage');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const verifyOtpBtn = document.getElementById('verifyOtpBtn');
const otpInput = document.getElementById('otp');
const phoneInput = document.getElementById('phone');

sendOtpBtn.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim();
  if(!phone){ alert("Masukkan nomor WA terlebih dahulu"); return; }
  try {
    const res = await fetch("http://localhost:3000/send-otp", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ phone })
    });
    const data = await res.json();
    if(data.success){
      alert("OTP berhasil dikirim ke WA");
      otpInput.classList.remove("hidden");
      verifyOtpBtn.classList.remove("hidden");
    } else {
      alert("Gagal kirim OTP");
    }
  } catch(e){ alert("Error API: "+e.message); }
});

verifyOtpBtn.addEventListener('click', async ()=>{
  const phone = phoneInput.value.trim();
  const otp = otpInput.value.trim();
  if(!otp){ alert("Masukkan OTP"); return; }
  try {
    const res = await fetch("http://localhost:3000/verify-otp", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ phone, otp })
    });
    const data = await res.json();
    if(data.success){
      alert("Login berhasil!");
      loginPage.classList.remove("active");
      mainPage.classList.add("active");
    } else {
      alert("OTP salah!");
    }
  } catch(e){ alert("Error API: "+e.message); }
});

/* ========== STORAGE SIMPEL ========== */
const storage = {
  get:(k,def)=>JSON.parse(localStorage.getItem(k) || JSON.stringify(def)),
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const BAL_KEY = "balance", TX_KEY="transactions";

/* ========== PLN DEMO ========== */
const plnProducts = [
  { nominal:"20.000", harga:20000, admin:2500, diskon:1000 },
  { nominal:"50.000", harga:50000, admin:2500, diskon:2000 },
  { nominal:"100.000", harga:100000, admin:2500, diskon:5000 },
];
let plnSelected = null;

function rupiah(x){ return "Rp"+x.toLocaleString("id-ID"); }

function selectPln(i){
  plnSelected = i;
  document.querySelectorAll("#plnGrid .price-card").forEach((x,j)=>{
    x.classList.toggle("active", j===i);
  });
  updatePlnSummary();
}

function updatePlnSummary(){
  const sum = document.getElementById('plnSummary');
  if(plnSelected===null){ sum.classList.add('hidden'); return; }
  const p = plnProducts[plnSelected];
  const total = p.harga + p.admin - p.diskon;
  document.getElementById('plnHarga').innerText = rupiah(p.harga);
  document.getElementById('plnAdmin').innerText = rupiah(p.admin);
  document.getElementById('plnDiskon').innerText = "- "+rupiah(p.diskon);
  document.getElementById('plnTotal').innerText = rupiah(total);
  sum.classList.remove('hidden');
}

document.getElementById('plnReset').addEventListener('click', ()=>{
  plnSelected=null;
  document.querySelectorAll('#plnGrid .price-card').forEach(x=>x.classList.remove('active'));
  document.getElementById('plnSummary').classList.add('hidden');
  document.getElementById('plnId').value='';
});

document.getElementById('plnBayar').addEventListener('click', ()=>{
  const idpel = document.getElementById('plnId').value.trim();
  if(!/^[0-9]{10,13}$/.test(idpel)){ alert("ID pelanggan tidak valid"); return; }
  if(plnSelected===null){ alert("Pilih nominal dulu"); return; }
  const p = plnProducts[plnSelected];
  const total = p.harga + p.admin - p.diskon;
  let bal = storage.get(BAL_KEY,0);
  if(bal < total){ alert("Saldo tidak cukup"); return; }
  bal -= total; storage.set(BAL_KEY,bal);
  document.getElementById('balance').innerText = bal.toLocaleString("id-ID");

  const tx = storage.get(TX_KEY,[]);
  tx.unshift({
    id:"TXN"+Date.now(),
    ts:new Date().toISOString(),
    type:"listrik",
    target:idpel,
    nominal:p.nominal,
    harga:p.harga,
    admin:p.admin,
    diskon:p.diskon,
    total:total,
    status:"Sukses",
    token:"TKN-"+Math.random().toString(36).slice(2,10).toUpperCase()
  });
  storage.set(TX_KEY, tx);
  renderHistory();
  alert("Pembelian sukses");
  document.getElementById('plnReset').click();
});

/* ========== HISTORY ========== */
function renderHistory(){
  const list=document.getElementById("txnList");
  const empty=document.getElementById("emptyTxn");
  const txs=storage.get(TX_KEY,[]);
  list.innerHTML="";
  if(!txs.length){ empty.classList.remove("hidden"); return; }
  empty.classList.add("hidden");
  txs.forEach(tx=>{
    const row=document.createElement("div");
    row.className="txn-item";
    row.innerHTML=`<div>
      <div>${tx.type}</div>
      <div class="text-xs">${new Date(tx.ts).toLocaleString("id-ID")} • ${tx.target}</div>
      <div>${tx.nominal} ${tx.token? '• Token: '+tx.token:''}</div>
    </div>
    <div><b>${rupiah(tx.total)}</b><br><span class="badge">${tx.status}</span></div>`;
    list.appendChild(row);
  });
}
renderHistory();

/* ========== TOPUP / WITHDRAW ========== */
document.getElementById("topUpBtn").addEventListener("click",()=>{
  const v=prompt("Masukkan nilai top up","50000");
  const n=parseInt((v||"").replace(/\D/g,""),10);
  if(!n)return;
  let bal=storage.get(BAL_KEY,0); bal+=n;
  storage.set(BAL_KEY,bal);
  document.getElementById("balance").innerText=bal.toLocaleString("id-ID");
});
document.getElementById("withdrawBtn").addEventListener("click",()=>{
  const v=prompt("Masukkan nilai tarik","50000");
  const n=parseInt((v||"").replace(/\D/g,""),10);
  if(!n)return;
  let bal=storage.get(BAL_KEY,0);
  if(bal<n){alert("Saldo kurang");return;}
  bal-=n;
  storage.set(BAL_KEY,bal);
  document.getElementById("balance").innerText=bal.toLocaleString("id-ID");
});
</script>

</body>
</html>
